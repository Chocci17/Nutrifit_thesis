<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Supabase Connection</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
    button { padding: 10px 20px; margin: 10px 5px; cursor: pointer; }
    .success { color: green; }
    .error { color: red; }
    .info { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; }
    pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
  </style>
</head>
<body>
  <h1>Supabase Connection Test</h1>
  
  <div class="info">
    <h3>Test Controls</h3>
    <button onclick="testConnection()">1. Test Connection</button>
    <button onclick="checkTables()">2. Check Tables</button>
    <button onclick="testSignup()">3. Test Signup</button>
    <button onclick="listUsers()">4. List Auth Users</button>
    <button onclick="listProfiles()">5. List Profiles</button>
  </div>

  <div id="output"></div>

  <script>
    const SUPABASE_URL = 'https://pncfzxuecxzcdyxdwuok.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBuY2Z6eHVlY3h6Y2R5eGR3dW9rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4Njg1NzEsImV4cCI6MjA3ODQ0NDU3MX0.BlfihjUmYAgP-9UisG4EN1srsteB_SZ9ut5TiBgAQ-E';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    function log(message, type = 'info') {
      const output = document.getElementById('output');
      const div = document.createElement('div');
      div.className = type;
      div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
      output.appendChild(div);
    }

    function logJSON(label, data) {
      const output = document.getElementById('output');
      const div = document.createElement('div');
      div.innerHTML = `<strong>${label}:</strong><pre>${JSON.stringify(data, null, 2)}</pre>`;
      output.appendChild(div);
    }

    async function testConnection() {
      log('Testing Supabase connection...');
      try {
        const { data, error } = await supabase.from('profiles').select('count');
        if (error) throw error;
        log('✅ Connection successful!', 'success');
        logJSON('Response', data);
      } catch (err) {
        log('❌ Connection failed: ' + err.message, 'error');
        logJSON('Error details', err);
      }
    }

    async function checkTables() {
      log('Checking if profiles table exists...');
      try {
        const { data, error } = await supabase.from('profiles').select('*').limit(1);
        if (error) {
          if (error.code === '42P01') {
            log('❌ Table "profiles" does not exist! You need to create it.', 'error');
            log('Run this SQL in Supabase SQL Editor:', 'info');
            const sql = `
create table if not exists profiles (
  id uuid references auth.users on delete cascade primary key,
  first_name text,
  last_name text,
  created_at timestamp with time zone default now()
);

alter table profiles enable row level security;

create policy "Users can view own profile"
  on profiles for select
  using (auth.uid() = id);

create policy "Users can insert own profile"
  on profiles for insert
  with check (auth.uid() = id);

create policy "Users can update own profile"
  on profiles for update
  using (auth.uid() = id);
            `;
            logJSON('SQL to run', sql);
          } else {
            throw error;
          }
        } else {
          log('✅ Table "profiles" exists!', 'success');
          logJSON('Sample data', data);
        }
      } catch (err) {
        log('❌ Error checking tables: ' + err.message, 'error');
        logJSON('Error details', err);
      }
    }

    async function testSignup() {
      const testEmail = 'testuser' + Date.now() + '@gmail.com';
      const testPassword = 'Test123456!';
      
      log(`Testing signup with email: ${testEmail}`);
      
      try {
        // Sign up
        const { data, error } = await supabase.auth.signUp({
          email: testEmail,
          password: testPassword,
          options: {
            data: {
              first_name: 'Test',
              last_name: 'User'
            }
          }
        });

        if (error) throw error;

        log('✅ Signup successful!', 'success');
        logJSON('Signup data', data);

        if (data.user && data.session) {
          log('User has active session - attempting profile insert...');
          // Try to insert profile only if session exists
          const { error: profileError } = await supabase
            .from('profiles')
            .insert([{
              id: data.user.id,
              first_name: 'Test',
              last_name: 'User',
              created_at: new Date().toISOString()
            }]);

          if (profileError) {
            log('❌ Profile insert failed: ' + profileError.message, 'error');
            logJSON('Profile error details', profileError);
          } else {
            log('✅ Profile created successfully!', 'success');
          }
        } else if (data.user && !data.session) {
          log('⚠️ User created but no session (email confirmation required)', 'info');
          log('Profile will need to be created via database trigger or after email confirmation', 'info');
        }

      } catch (err) {
        log('❌ Signup failed: ' + err.message, 'error');
        logJSON('Error details', err);
      }
    }

    async function listUsers() {
      log('Note: Listing auth users requires service role key (not available from client)');
      log('Check Authentication > Users in Supabase Dashboard', 'info');
    }

    async function listProfiles() {
      log('Attempting to list profiles...');
      try {
        const { data, error } = await supabase
          .from('profiles')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) throw error;

        log(`✅ Found ${data.length} profiles`, 'success');
        logJSON('Profiles', data);
      } catch (err) {
        log('❌ Error listing profiles: ' + err.message, 'error');
        logJSON('Error details', err);
      }
    }

    // Auto-test connection on load
    window.addEventListener('DOMContentLoaded', () => {
      log('Page loaded. Click buttons to test Supabase.');
    });
  </script>
</body>
</html>
